@page "/myAccounts"
@inject IAccountService AccountService;
@using BlazorStandaloneApp.Domain

@* 
Summary:
Displays all of the user's bank accounts with details such as type, balance, 
interest rate, and last updated date. Allows removal of accounts with zero balance.
*@

<PageTitle>My accounts</PageTitle>

<h1>My accounts</h1>

@if(_accounts.Count == 0)
{
    <p>There are no accounts, create your first under New account.</p>
}
else
{
    <table class="accounts-table">
        <thead>
            <tr>
                <th>Account name</th>
                <th>Account type</th>
                <th>Balance</th>
                <th>Interest rate</th>
                <th>Accumulated interest</th>
                <th>Last updated</th>
                <th><!-- Potential remove button --></th>
            </tr>
        </thead>
        <tbody>
        @foreach (var account in _accounts)
        {
            <tr>
                <td>@account.Name</td>
                <td>@account.AccountType</td>
                <td>@account.Balance @account.CurrencyType</td>
                <td>
                @if (account.AccountType == AccountType.Savings)
                {
                    @(BankAccount.InterestRate * 100)
                }
                </td>
                <td>@account.ApplyInterest().ToString() @account.CurrencyType</td>
                <td>@account.LastUpdated.ToLocalTime()</td>
                <td>
                @if (account.Balance == 0)
                    {
                        <button class="remove-btn" @onclick="() => RemoveAccount(account)">Remove</button>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
}


@code {
    private CreateAccountModel _model = new();
    private List<BankAccount> _accounts = new();

    // Load all user accounts when the page initializes
    protected override async Task OnInitializedAsync()
    {
        _accounts = await AccountService.GetAccounts();
    }

    // Create a new account and refresh the list
    private async Task CreateAccountAsync()
    {
        try{
            await AccountService.CreateAccount(
            _model.Name!,
            _model.AccountType,
            _model.InitialBalance);

            _accounts = await AccountService.GetAccounts();
            _model.Clear();
        }
        catch (Exception exception)
        {
            Console.WriteLine(exception);
        }
    }

    // Remove an account (only possible if balance is zero)
    private async Task RemoveAccount(IBankAccount account)
    {
        try
        {
            await AccountService.DeleteAccount(account);
            _accounts = await AccountService.GetAccounts();
        }
        catch (Exception exception)
        {
            Console.WriteLine(exception);
        }
    }

    // Model for handling new account creation (shared structure)
    private class CreateAccountModel
    {
        public string? Name { get; set; }
        public AccountType AccountType { get; set; }
        public decimal InitialBalance { get; set; } = 0;

        public void Clear()
        {
            Name = string.Empty;
            InitialBalance = 0;
            AccountType = default;
        }
    }
}